<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>글쓰기</title>
    <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">
    <!-- head 안 -->
    <script th:src="@{/se2/js/service/HuskyEZCreator.js}" charset="utf-8"></script>
    <link rel="preload" as="document" href="/se2/SmartEditor2Skin.html">


    <style>
        /* 가로폭 흔들림 방지(세로 스크롤 항상 예약) */
        html { overflow-y: scroll; }

        /* 에디터 자리 선고정: 편집영역 420 + 툴바/상태바 64 */
        :root { --se2-area: 420px; --se2-chrome: 64px; }
        #editor-slot { min-height: calc(var(--se2-area) + var(--se2-chrome)); }

        /* 원본 textarea는 레이아웃에서 제외 */
        #body{
            /* 레이아웃 안에 두고, 눈에만 안 보이게 */
            visibility: hidden;
            height: var(--se2-area);   /* 예: 420px */
            width: 100%;
            margin: 0; padding: 0; border: 0;
            box-sizing: border-box;
        }

        /* 로딩 중 카드 살짝 숨김(깜빡임 마스킹) */
        .is-loading .card { opacity: 0; }
        .card { transition: opacity .12s ease; }
    </style>

</head>

<body class="d-flex justify-content-center py-4 is-loading">
<div class="container mt-10">
    <div th:replace="fragments/alerts :: alerts"></div>
    <div class="card">
        <div class="card-header">새 글 작성</div>
        <div class="card-body">
            <form th:action="@{/posts/create}" method="post" enctype="multipart/form-data"
                  th:object="${post}" id="postForm" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-group">
                    <label for="title">제목</label>
                    <input id="title" type="text" th:field="*{title}" class="form-control" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                </div>

                <div class="form-group">
                    <label for="body">본문</label>
                    <div id="editor-slot">
                        <textarea id="body" th:field="*{body}" required></textarea>
                    </div>
                </div>





                <!--첨부파일-->

                <div class="form-group">
                    <label class="form-label">첨부파일</label>

                    <!-- 드롭존 + 버튼 -->
                    <div id="dz-create" class="border rounded p-3 text-center">
                        <div class="mb-2">파일을 여기로 끌어다 놓거나 파일 추가버튼을 클릭하세요.</div>
                        <button type="button" id="addBtn-create" class="btn btn-outline-secondary btn-sm">파일 추가</button>
                    </div>
                    <small class="text-muted">여러 번 눌러서 계속 추가할 수 있어요</small>

                    <!-- 실제로 서버로 제출되는 input (hidden) -->
                    <input id="files-create" name="files" type="file" class="d-none" multiple>
                    <!-- 매번 고르는 용도의 숨은 피커 -->
                    <input id="picker-create" type="file" class="d-none" multiple>

                    <!-- 선택 목록 -->
                    <ul id="list-create" class="list-group mt-2"></ul>
                </div>



                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-primary">등록</button>
                    <a th:href="@{/posts/list}" class="btn btn-secondary ml-2">취소</a>
                </div>
            </form>
        </div>
    </div>
</div>


<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/dist/js/adminlte.min.js}"></script>

<!-- ⬇⬇⬇ 이 주석 아래부터 복붙 -->
<!-- [1] Bootstrap 모달 -->
<div class="modal fade" id="sizeLimitModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">파일 크기 제한 초과</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="닫기">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="sizeLimitBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>








<!--스마트에디터-->



<!-- body 하단 -->
<!-- 스킨을 미리 당겨오면 초기 지연이 줄어듭니다 -->

<script th:inline="javascript">
    var oEditors = [];
    var skinUri = /*[[@{/se2/SmartEditor2Skin.html}]]*/ '/se2/SmartEditor2Skin.html';

    function fixSE2InnerWidth(){
        var iframe = document.querySelector('#editor-slot iframe');
        if(!iframe) return;
        var doc = iframe.contentDocument || iframe.contentWindow?.document;
        if(!doc) return;

        // 이미 주입했으면 중복 방지
        if (doc.getElementById('se2-width-fix')) return;

        var style = doc.createElement('style');
        style.id = 'se2-width-fix';
        style.textContent = `
      html, body { width:100% !important; overflow-x:hidden !important; }
      /* 스킨 내부 래퍼들을 전부 100%로 */
      .se2_mwrapper, .se2_inwrap, .se2_workarea, .se2_workspace,
      .se2_editor, .se2_input_area, .se2_iframe, .se2_ui_layout,
      .se2_container, .se2_canvas, .se2_wysiwyg_area {
        width:100% !important; max-width:100% !important;
      }
    `;
        doc.head.appendChild(style);
    }

    nhn.husky.EZCreator.createInIFrame({
        oAppRef: oEditors,
        elPlaceHolder: "body",
        sSkinURI: skinUri,
        fCreator: "createSEditor2",
        htParams: { bUseToolbar:true, bUseVerticalResizer:false, bUseModeChanger:true },
        fOnAppLoad: function () {
            // 높이 맞추기
            var H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--se2-area')) || 420;
            try { oEditors.getById["body"].exec("RESIZE_EDITING_AREA", [H]); } catch(e){}

            // ★ iFrame 내부 폭 강제 주입
            // 약간 늦게 한 번 더 실행해서 초기 레이아웃 이후도 덮어쓴다
            fixSE2InnerWidth();
            requestAnimationFrame(fixSE2InnerWidth);

            // 슬롯 잠금 해제 + 가운데 정렬 전환(네 코드 유지)
            var slot = document.getElementById('editor-slot');
            if (slot) slot.style.minHeight = '0';
            document.body.classList.remove('is-loading');
            document.body.classList.add('align-items-center','min-vh-100');
        }
    });

    // 창 크기 변경 시도 내부가 px로 돌아가면 다시 강제
    window.addEventListener('resize', function(){ requestAnimationFrame(fixSE2InnerWidth); });

    // 제출 시 본문 반영(네 코드 유지)
    document.getElementById('postForm')?.addEventListener('submit', function(){
        try { oEditors.getById["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}
    });
</script>


<script>
    (function(){
        const form  = document.getElementById('postForm');
        const title = document.getElementById('title');
        const body  = document.getElementById('body');

        function updateEditor(){
            try { oEditors.getById["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}
        }

        // 버튼 클릭 시 먼저 에디터 내용을 textarea에 반영
        document.querySelector('button[type="submit"]').addEventListener('click', updateEditor);

        // 폼 제출 시(엔터로 제출 등)도 한 번 더 반영하고 직접 검증
        form.addEventListener('submit', function(e){
            updateEditor();

            if (!title.value.trim()){
                alert('제목을 입력하세요.');
                title.focus(); e.preventDefault(); return;
            }
            if (!body.value.trim()){
                alert('본문을 입력하세요.');
                // 에디터에 포커스 주고 싶으면:
                try { oEditors.getById["body"]?.exec("FOCUS"); } catch(e){}
                e.preventDefault(); return;
            }
        });
    })();
</script>


<!-- [2] 파일 사이즈 검사 스크립트 -->
<script>
    (function(){
        // ⚠️ 서버 yml(spring.servlet.multipart)과 숫자를 반드시 맞추세요.
        var MAX_FILE_SIZE_MB = 20;  // 파일 1개 최대
        var MAX_REQ_SIZE_MB  = 25;  // 요청 전체(합계) 최대
        var MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;
        var MAX_REQ_SIZE  = MAX_REQ_SIZE_MB  * 1024 * 1024;

        function fmt(b){
            var u=['B','KB','MB','GB'], i=0, n=b;
            while(n>=1024 && i<u.length-1){ n/=1024; i++; }
            return (n<10&&i>0? n.toFixed(1):Math.round(n)) + ' ' + u[i];
        }

        function validate($input){
            var f = $input[0].files;
            if(!f || f.length===0) return true;

            var total = 0, over = [];
            for(var i=0;i<f.length;i++){
                total += f[i].size;
                if (f[i].size > MAX_FILE_SIZE) over.push(f[i]);
            }

            if (over.length || total > MAX_REQ_SIZE){
                var html = '';
                if (over.length){
                    html += '<div class="mb-2">개별 파일은 최대 <b>'+MAX_FILE_SIZE_MB+'MB</b>까지 허용합니다.</div><ul>';
                    for (var j=0;j<over.length;j++){
                        html += '<li>'+over[j].name+' — '+fmt(over[j].size)+'</li>';
                    }
                    html += '</ul>';
                }
                if (total > MAX_REQ_SIZE){
                    html += '<div class="mt-2">선택한 파일 합계가 <b>'+MAX_REQ_SIZE_MB+'MB</b>를 초과했습니다. (현재 '+fmt(total)+')</div>';
                }
                $('#sizeLimitBody').html(html);
                $('#sizeLimitModal').modal('show');
                $input.val(''); // 잘못 선택한 파일 비우기
                return false;
            }
            return true;
        }

        $(function(){
            // 두 페이지 모두 input id="files"를 쓰고 있으니 이걸 기준으로 훅킹
            var $input = $('#files');
            if($input.length){
                $input.on('change', function(){ validate($input); });
                $input.closest('form').on('submit', function(e){
                    if(!validate($input)){ e.preventDefault(); e.stopPropagation(); }
                });
            }
        });
    })();
</script>

<!--첨부파일 추가방식 변경 누적으로-->

<script>
    (function(){
        // 서버 yml과 숫자 맞추기
        var MAX_FILE_SIZE_MB = 20;
        var MAX_REQ_SIZE_MB  = 25;
        var MAX_FILE_SIZE = MAX_FILE_SIZE_MB*1024*1024;
        var MAX_REQ_SIZE  = MAX_REQ_SIZE_MB*1024*1024;

        function fmt(b){var u=['B','KB','MB','GB'],i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (n<10&&i>0?n.toFixed(1):Math.round(n))+' '+u[i];}
        function keyOf(f){ return [f.name,f.size,f.lastModified].join('#'); }

        function showSizeModal(html){
            $('#sizeLimitBody').html(html);
            $('#sizeLimitModal').modal('show');
        }

        function wirePicker(opts){
            var $form  = $(opts.formSelector || 'form');
            var $btn   = $(opts.btnId);
            var $dz    = $(opts.dropzoneId);
            var $picker= $(opts.pickerId);      // 매번 고르는 숨은 picker
            var $input = $(opts.submitInputId); // 실제 제출되는 hidden input (name="files")
            var $list  = $(opts.listId);

            if(!$btn.length || !$picker.length || !$input.length || !$list.length) return;

            var selected = new Map(); // key -> File

            function validate(files){
                var total = 0, over = [];
                var all = Array.from(selected.values()).concat(Array.from(files));
                for(var i=0;i<all.length;i++){
                    total += all[i].size;
                    if (all[i].size > MAX_FILE_SIZE) over.push(all[i]);
                }
                if (over.length || total > MAX_REQ_SIZE){
                    var html='';
                    if (over.length){
                        html += '<div class="mb-2">개별 파일은 최대 <b>'+MAX_FILE_SIZE_MB+'MB</b>까지 허용합니다.</div><ul>';
                        over.forEach(function(f){ html+='<li>'+f.name+' — '+fmt(f.size)+'</li>'; });
                        html += '</ul>';
                    }
                    if (total > MAX_REQ_SIZE){
                        html += '<div class="mt-2">선택한 파일 합계가 <b>'+MAX_REQ_SIZE_MB+'MB</b>를 초과했습니다. (현재 '+fmt(total)+')</div>';
                    }
                    showSizeModal(html);
                    return false;
                }
                return true;
            }

            function syncHiddenInput(){
                var dt = new DataTransfer();
                selected.forEach(function(f){ dt.items.add(f); });
                $input[0].files = dt.files;
            }

            function render(){
                $list.empty();
                if (selected.size === 0){
                    $list.append('<li class="list-group-item text-muted">선택된 파일이 없습니다.</li>');
                    return;
                }
                selected.forEach(function(f, k){
                    var $li = $('<li class="list-group-item d-flex justify-content-between align-items-center"></li>');
                    $li.append('<span>'+f.name+' <small class="text-muted">— '+fmt(f.size)+'</small></span>');
                    var $del = $('<button type="button" class="btn btn-sm btn-outline-danger">삭제</button>');
                    $del.on('click', function(){
                        selected.delete(k);
                        syncHiddenInput(); render();
                    });
                    $li.append($del);
                    $list.append($li);
                });
            }

            function addFiles(fileList){
                var arr = Array.from(fileList || []);
                // 중복 제거
                var unique = arr.filter(function(f){ return !selected.has(keyOf(f)); });
                if (unique.length === 0) return;

                if (!validate(unique)) return;

                unique.forEach(function(f){ selected.set(keyOf(f), f); });
                syncHiddenInput(); render();
            }

            // 버튼 → 파일 선택
            $btn.on('click', function(){ $picker.trigger('click'); });
            $picker.on('change', function(){ addFiles(this.files); this.value=''; });

            // 드래그&드롭
            $dz.on('dragover', function(e){ e.preventDefault(); e.originalEvent.dataTransfer.dropEffect='copy'; $dz.addClass('bg-light'); });
            $dz.on('dragleave', function(){ $dz.removeClass('bg-light'); });
            $dz.on('drop', function(e){
                e.preventDefault(); $dz.removeClass('bg-light');
                addFiles(e.originalEvent.dataTransfer.files);
            });

            // 제출 전 한 번 더 검사(이중 안전장치)
            $form.on('submit', function(e){
                if (!validate([])){ e.preventDefault(); e.stopPropagation(); }
            });

            render(); // 초기 렌더
        }

        // 페이지에 맞춰 두 번 바인딩
        $(function(){
            // create.html
            wirePicker({
                btnId:'#addBtn-create',
                dropzoneId:'#dz-create',
                pickerId:'#picker-create',
                submitInputId:'#files-create',
                listId:'#list-create'
            });

            // update.html
            wirePicker({
                btnId:'#addBtn-update',
                dropzoneId:'#dz-update',
                pickerId:'#picker-update',
                submitInputId:'#files-update',
                listId:'#list-update'
            });
        });
    })();
</script>



</body>
</html>
