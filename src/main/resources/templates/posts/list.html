<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="/js/beforeunload-killer.js"></script>
    <meta charset="utf-8">
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>


    <!-- â–¼ íŒŒë¹„ì½˜ (ê¸°ì¡´ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´) -->
    <link rel="icon" type="image/png" href="/dist/img/AdminLTELogo.png">


    <link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">

    <!-- âœ… AJAXì—ì„œ ì“¸ CSRF ë©”íƒ€ -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <!-- SmartEditor2 -->
    <script th:src="@{/se2/js/service/HuskyEZCreator.js}" charset="utf-8"></script>
    <link rel="preload" href="/se2/SmartEditor2Skin.html" as="fetch">

    <!-- ì—ë””í„° ë°”ê¹¥ iframe 100% -->
    <style>
        #editor-slot iframe { width:100% !important; min-width:100% !important; display:block; }
        #editor-slot { width:100%; }
    </style>

    <!-- create ì¹´ë“œ í­ì„ listì™€ ë…ë¦½ì ìœ¼ë¡œ ì œì–´ -->
    <style>
        .create-inline-wrap {
            max-width: 980px;      /* create í˜ì´ì§€ ëŠë‚Œì˜ í­ */
            margin: 48px auto 0;   /* ìœ„ ì—¬ë°± + ê°€ìš´ë° ì •ë ¬ */
        }
    </style>




    <!-- âœ… ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ì—ì„œ beforeunload ê²½ê³  ì™„ì „ ì°¨ë‹¨ (ì •ìƒ ë²„ì „: preventDefault ì ˆëŒ€ ê¸ˆì§€) -->
    <script>
        (function () {
            // ì•ìœ¼ë¡œ ë“±ë¡ë  beforeunload ë¦¬ìŠ¤ë„ˆ ìì²´ë¥¼ ì°¨ë‹¨
            const _add = window.addEventListener;
            window.addEventListener = function (type, listener, options) {
                if (type === 'beforeunload') return; // ë“±ë¡ ë¬´ì‹œ
                return _add.call(this, type, listener, options);
            };

            // window.onbeforeunload = ... ê°™ì€ ì§ì ‘ í• ë‹¹ë„ ì›ì²œë´‰ì‡„
            try {
                Object.defineProperty(window, 'onbeforeunload', {
                    configurable: true,
                    get() { return null; },
                    set(_) { /* block */ }
                });
            } catch (_) {}

            // í˜¹ì‹œ ì´ë¯¸ ë¶™ì–´ìˆëŠ” ë¦¬ìŠ¤ë„ˆë³´ë‹¤ ë¨¼ì € ì‹¤í–‰í•´ì„œ â€œì „íŒŒë§Œâ€ ëŠëŠ”ë‹¤.
            // âš ï¸ ì—¬ê¸°ì„œ ì ˆëŒ€ e.preventDefault()ë‚˜ e.returnValue ì„¤ì •í•˜ì§€ ë§ ê²ƒ!
            _add.call(window, 'beforeunload', function (e) {
                e.stopImmediatePropagation(); // ë‹¤ë¥¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ ëª» í•˜ê²Œ
                // do NOT call e.preventDefault()
                // do NOT set e.returnValue
            }, true);

            // jQueryê°€ ë¯¸ë¦¬ ë¶™ì˜€ë˜ê²Œ ìˆìœ¼ë©´ ì œê±° ì‹œë„
            if (window.jQuery) {
                try { jQuery(window).off('beforeunload'); jQuery(document).off('beforeunload'); } catch (_) {}
            }
        })();
    </script>

    <style>
        /* ì¹´ë“œ í—¤ë”ì—ì„œ ê²€ìƒ‰ í¼ì„ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ */
        .card-header .search-form { margin-left: auto !important; }

        /* í˜¹ì‹œ ê°€ìš´ë° ì •ë ¬ì´ ë‚¨ì•„ìˆì„ ë•Œ ê°•ì œ í•´ì œ */
        .card-header { text-align: left; }
    </style>




</head>

<body class="hold-transition">
<div class="container-fluid my-4"><!-- .container-fluid: í˜ì´ì§€ ì „ì²´ í­ -->
    <div class="row">
        <div class="col-12 col-lg-11 col-xl-10 mx-auto"><!-- ì¤‘ì•™ ê³ ì •í­ ì»¨í…Œì´ë„ˆ -->

            <!-- ìƒë‹¨ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->


            <div class="d-flex justify-content-end align-items-center mb-4">
                <form th:action="@{/logout}" method="post" class="mb-0">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </div>


            <!-- ì•Œë¦¼ -->
            <div th:replace="~{fragments/alerts :: alerts}"></div>

            <!-- ëª©ë¡ ì¹´ë“œ -->
            <div class="card">
                <div class="card-header d-flex align-items-center">
                    <h3 class="card-title mb-0">ê²Œì‹œê¸€ ëª©ë¡</h3>

                    <!-- ğŸ”¥ ê²€ìƒ‰ì°½: ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ë°€ê¸° ìœ„í•´ search-formì— margin-left:auto -->
                    <form th:action="@{/posts/list}" method="get" class="search-form mb-0">
                        <div class="input-group input-group-sm" style="width: 420px;">
                            <!-- í•„ë“œ ì„ íƒ -->
                            <select name="field" class="form-control" style="max-width:130px;">
                                <option value="title" th:selected="${field} == 'title'">ì œëª©</option>
                                <option value="body"  th:selected="${field} == 'body'">ë‚´ìš©</option>
                                <option value="user"  th:selected="${field} == 'user'">ì•„ì´ë””</option>
                            </select>

                            <!-- ê²€ìƒ‰ì–´ -->
                            <input type="text" name="q" class="form-control" placeholder="ê²€ìƒ‰ì–´" th:value="${q}">

                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                </div>


                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap">
                        <thead>
                        <tr class="text-center">
                            <th style="width:80px;">ê¸€ë²ˆí˜¸</th>
                            <th>ì œëª©</th>
                            <th>ë‚´ìš©</th>
                            <th style="width:90px;">ì²¨ë¶€íŒŒì¼</th>
                            <th style="width:180px;">íšŒì›ì•„ì´ë””</th>
                            <th style="width:170px;">ì‘ì„±ì¼</th>
                            <th style="width:170px;">ìˆ˜ì •ì¼</th>
                        </tr>
                        </thead>
                        <tbody id="post-list-body">
                        <tr th:each="p : ${posts.content}" class="text-center">
                            <td th:text="${p.id}"></td>
                            <td><a th:href="@{/posts/{id}(id=${p.id})}" th:text="${p.title}"data-bypass-unload="true">ì œëª©</a></td>
                            <td th:text="${p.bodyPreview}">ë¯¸ë¦¬ë³´ê¸°</td>
                            <td th:text="${idsWithFiles.contains(p.id)} ? 'Y' : ''" class="col-hasfile"></td>
                            <td th:text="${p.authorUserId}"></td>
                            <td th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="${#temporals.format(p.updateAt, 'yyyy-MM-dd HH:mm')}"></td>
                        </tr>
                        <tr id="no-posts-row" th:if="${#lists.isEmpty(posts.content)}">
                            <td colspan="6" class="text-center text-muted p-4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-right">
                        <li class="page-item" th:classappend="${posts.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/posts/list(page=${posts.number-1}, size=${posts.size}, q=${q},field=${field})}">&laquo;</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, posts.totalPages-1)}"
                            th:classappend="${i} == ${posts.number} ? 'active'">
                            <a class="page-link"
                               th:text="${i+1}"
                               th:href="@{/posts/list(page=${i}, size=${posts.size}, q=${q}, field=${field})}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${posts.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/posts/list(page=${posts.number+1}, size=${posts.size}, q=${q},field=${field})}">&raquo;</a>
                        </li>
                    </ul>
                </div>
            </div><!-- /.card -->
            <div class="d-flex justify-content-end mb-3">
                <!-- ëª©ë¡: í°ìƒ‰(ì•„ì›ƒë¼ì¸) + ì˜¤ë¥¸ìª½ ë²„íŠ¼ê³¼ ê°„ê²© -->
                <a th:href="@{/posts/list(page=0, size=${posts.size})}"
                   class="btn btn-outline-secondary mr-2"
                   data-bypass-unload="true">ëª©ë¡</a>

                <!-- ê¸€ì“°ê¸°: íŒŒë€ìƒ‰ ê¸°ë³¸ -->
                <a th:href="@{/posts/create}"
                   class="btn btn-primary"
                   data-bypass-unload="true">ê¸€ì“°ê¸°</a>
            </div>


            <div class="clearfix"></div>

            <!-- ì¸ë¼ì¸ create: list í­ê³¼ ë…ë¦½ -->
            <div class="create-inline-wrap container mt-4">

<!--                divë¡œ ê³µê°„ì„ ë§Œë“¤ì–´ì„œ create-inline(listì— ì¶”ê°€í•  createí¼)ì„ ë„£ì–´ ì¹˜í™˜, ìŠ¤í”„ë§+íƒ€ì„ë¦¬í”„ê°€ ì„œë²„ì—ì„œ í…œí”Œë¦¿ì„ htmlë¡œ ë Œë”í•´ì„œ ë¸Œë¼ìš°ì €ë¡œ ë³´ë‚´ëŠ” ì„œë²„ì‚¬ì´ë“œ. th:replaceëŠ” ì„œë²„ì‚¬ì´ë“œ ì¡°ë¦½-->
                <div th:replace="~{posts/_create-inline :: inlineCreate}"></div>
            </div>

        </div><!-- /.col -->
    </div><!-- /.row -->
</div><!-- /.container-fluid -->

<!-- í•„ìˆ˜ JS -->
<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/dist/js/adminlte.min.js}"></script>

<!-- ì—ë””í„° í­ ë³´ê°•: iframe ëœ° ë•Œê¹Œì§€ ì§§ê²Œ í´ë§ -->
<script th:inline="javascript">
    var __se2Watch = setInterval(function(){
        var iframe = document.querySelector('#editor-slot iframe');
        if(!iframe) return;
        var doc = iframe.contentDocument || iframe.contentWindow?.document;
        if(!doc) return;
        try { if (window.makeSE2Responsive) window.makeSE2Responsive(); } catch(e){}
        clearInterval(__se2Watch);
    }, 120);
    setTimeout(function(){ clearInterval(__se2Watch); }, 8000);
</script>

<!-- SmartEditor2 ìŠ¤í‚¨ ë¡œë“œ + ë°˜ì‘í˜• ë³´ì • -->
<script th:inline="javascript">
    var oEditors = [];
    var skinUri = /*[[@{/se2/SmartEditor2Skin.html}]]*/ '/se2/SmartEditor2Skin.html';
    skinUri += (skinUri.indexOf('?') === -1 ? '?' : '&') + 'v=' + Date.now();

    function makeSE2Responsive(){
        var iframe = document.querySelector('#editor-slot iframe') ||
            document.querySelector('iframe[src*="SmartEditor2Skin"]');
        if (!iframe) return false;

        iframe.style.width = '100%';
        iframe.removeAttribute('width');

        var doc = iframe.contentDocument || iframe.contentWindow?.document;
        if (!doc) return false;

        if (!doc.getElementById('se2-rwd-css')) {
            var style = doc.createElement('style');
            style.id = 'se2-rwd-css';
            style.textContent = `
          html, body { width:100% !important; overflow-x:hidden !important; }
          .se2_mwrapper, .se2_inwrap, .se2_workarea, .se2_workspace,
          .se2_editor, .se2_input_area, .se2_ui_layout,
          .se2_container, .se2_canvas, .se2_wysiwyg_area,
          iframe, table, td { max-width:100% !important; width:100% !important; }
        `;
            doc.head.appendChild(style);
        }

        function normalize(root){
            root.querySelectorAll('[width], [style*="width"]').forEach(function(el){
                var wAttr = el.getAttribute && el.getAttribute('width');
                if (wAttr && /^\d+$/.test(wAttr)) el.setAttribute('width', '100%');
                var sw = el.style && el.style.width;
                if (sw && /px/.test(sw)) el.style.width = '100%';
            });
        }
        normalize(doc);

        if (!doc.__se2Observer) {
            doc.__se2Observer = new MutationObserver(function(muts){
                muts.forEach(function(m){
                    if (m.type === 'attributes') normalize(m.target);
                    m.addedNodes && m.addedNodes.forEach(function(n){
                        if (n.nodeType === 1) normalize(n);
                    });
                });
            });
            doc.__se2Observer.observe(doc.documentElement, {
                subtree: true, childList: true, attributes: true,
                attributeFilter: ['style','width']
            });
        }
        return true;
    }

    // SmartEditor2 ìƒì„±
    nhn.husky.EZCreator.createInIFrame({
        oAppRef: oEditors,
        elPlaceHolder: "body",
        sSkinURI: skinUri,
        fCreator: "createSEditor2",
        htParams: { bUseToolbar:true, bUseVerticalResizer:false, bUseModeChanger:true },
        fOnAppLoad: function () {
            try { oEditors.getById["body"].exec("RESIZE_EDITING_AREA", [420]); } catch(e){}
            // í­ ë³´ì • ê°€ë™
            (function arm(){
                var ok = makeSE2Responsive();
                if (ok) return;
                var tries = 0, t = setInterval(function(){
                    if (makeSE2Responsive() || ++tries > 60) clearInterval(t);
                }, 100);
            })();
            setTimeout(makeSE2Responsive, 400);
        }
    });

    // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ë„ ë³´ì •
    window.addEventListener('resize', function(){ requestAnimationFrame(makeSE2Responsive); });
</script>

<!-- íŒŒì¼ ë“œë¡­/í”¼ì»¤ ìŠ¤í¬ë¦½íŠ¸ & AJAX ì œì¶œ (ë„¤ ê¸°ì¡´ ì½”ë“œ ìœ ì§€) -->
<script th:inline="javascript">
    (function(){
        var MAX_FILE_SIZE_MB = 20, MAX_REQ_SIZE_MB = 25;
        var MAX_FILE_SIZE = MAX_FILE_SIZE_MB*1024*1024, MAX_REQ_SIZE = MAX_REQ_SIZE_MB*1024*1024;

        function fmt(b){var u=['B','KB','MB','GB'],i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (n<10&&i>0?n.toFixed(1):Math.round(n))+' '+u[i];}
        function keyOf(f){ return [f.name,f.size,f.lastModified].join('#'); }
        function showSizeModal(html){ $('#sizeLimitBody').html(html); $('#sizeLimitModal').modal('show'); }

        function wirePicker(opts){
            var $form=$(opts.formSelector||'#postForm');
            var $btn=$(opts.btnId), $dz=$(opts.dropzoneId),
                $picker=$(opts.pickerId), $input=$(opts.submitInputId), $list=$(opts.listId);
            if(!$btn.length||!$picker.length||!$input.length||!$list.length) return;

            var selected=new Map();

            function validate(files){
                var total=0, over=[];
                var all=[...selected.values(), ...Array.from(files)];
                for(var i=0;i<all.length;i++){ total+=all[i].size; if(all[i].size>MAX_FILE_SIZE) over.push(all[i]); }
                if(over.length || total>MAX_REQ_SIZE){
                    var html='';
                    if(over.length){
                        html += '<div class="mb-2">ê°œë³„ íŒŒì¼ì€ ìµœëŒ€ <b>'+MAX_FILE_SIZE_MB+'MB</b>ê¹Œì§€ í—ˆìš©í•©ë‹ˆë‹¤.</div><ul>';
                        over.forEach(f=>html+='<li>'+f.name+' â€” '+fmt(f.size)+'</li>'); html+='</ul>';
                    }
                    if(total>MAX_REQ_SIZE){
                        html+='<div class="mt-2">ì„ íƒí•œ íŒŒì¼ í•©ê³„ê°€ <b>'+MAX_REQ_SIZE_MB+'MB</b>ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.</div>';
                    }
                    showSizeModal(html); return false;
                }
                return true;
            }
            function syncHidden(){
                var dt=new DataTransfer(); selected.forEach(f=>dt.items.add(f));
                $input[0].files = dt.files;
            }
            function render(){
                $list.empty();
                if(selected.size===0){ $list.append('<li class="list-group-item text-muted">ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>'); return; }
                selected.forEach(function(f,k){
                    var $li=$('<li class="list-group-item d-flex justify-content-between align-items-center"></li>');
                    $li.append('<span>'+f.name+' <small class="text-muted">â€” '+fmt(f.size)+'</small></span>');
                    var $del=$('<button type="button" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>');
                    $del.on('click', function(){ selected.delete(k); syncHidden(); render(); });
                    $li.append($del); $list.append($li);
                });
            }
            function addFiles(fileList){
                var arr=Array.from(fileList||[]), unique=arr.filter(f=>!selected.has(keyOf(f)));
                if(unique.length===0) return;
                if(!validate(unique)) return;
                unique.forEach(f=>selected.set(keyOf(f),f));
                syncHidden(); render();
            }
            $btn.on('click', ()=> $picker.trigger('click'));
            $picker.on('change', function(){ addFiles(this.files); this.value=''; });
            $dz.on('dragover', function(e){ e.preventDefault(); e.originalEvent.dataTransfer.dropEffect='copy'; $dz.addClass('bg-light'); });
            $dz.on('dragleave', function(){ $dz.removeClass('bg-light'); });
            $dz.on('drop', function(e){ e.preventDefault(); $dz.removeClass('bg-light'); addFiles(e.originalEvent.dataTransfer.files); });

            window.__resetFiles = function(){ selected.clear(); syncHidden(); render(); };
            render();
        }

        $(function(){
            wirePicker({
                btnId:'#addBtn-create',
                dropzoneId:'#dz-create',
                pickerId:'#picker-create',
                submitInputId:'#files-create',
                listId:'#list-create',
                formSelector:'#postForm'
            });
        });
    })();





    (function(){ //submitê°€ë¡œì±„ì„œ ë“±ë¡ì ˆì°¨ ì§„í–‰ createRowë¡œ ë³´ëƒ„ Controller
        var $form = $('#postForm'); //postFormì€ _crate-inline í¼
        if(!$form.length) return;

        function prependRowHtml(html){
            if(!html) return;
            $('#post-list-body').prepend(html); //post-list-body ê¸€ ë“¤ì–´ê°€ëŠ” ëª©ë¡ì— prepend(ì¶”ê°€)htmlì„.ì—¬ê¸°ì„œ htmlì€ _post-row.htmlì˜ tr~tr. ê³§ ê¸€ í•œì¤„ì„ ë§í•¨.ìµœê·¼ê¸€ì´ ë§¨ ìœ„ë¡œ ëœ¨ê²Œ.
            $('#no-posts-row').remove();
        }

        $form.on('submit', function(e){ //create-inlineí¼ì˜ submitì´ í´ë¦­ë˜ë©´ ê°€ë¡œì±ˆë‹¤
            e.preventDefault(); //ì›ë˜ì˜ "í˜ì´ì§€ ì´ë™" ë§‰ìŒ
            //ìŠ¤ë§ˆíŠ¸ ì—ë””í„°ì˜ ë‚´ìš©ì„ textarea(#body)ë¡œ ë³µì‚¬

            try { oEditors?.getById?.["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}
            var title = $('#title').val()?.trim();
            var body  = $('#body').val()?.trim();
            if(!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); $('#title').focus(); return; }
            if(!body){  alert('ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            var fd = new FormData(this); //this í˜„ì¬ submitëœ í¼ ë°ì´í„°, nameìœ¼ë¡œ í•„ë“œë¥¼ ëª¨ìœ¼ëŠ”ë° name="title" input title=123 name ="body" textarea body=ì•ˆë…•" ë­ ì´ëŸ°ì‹?
            $.ajax({
                url: $form.attr('action'),
                method: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                success: function (html) {
                    // 1) í–‰ prepend
                    prependRowHtml(html);

                    // 2) ë°©ê¸ˆ ì¶”ê°€ëœ ì²« í–‰ ì¡ê¸°
                    const tbody = document.getElementById('post-list-body');
                    const firstRow = tbody ? tbody.querySelector('tr') : null;

                    // 3) (ì„ íƒ) ìƒˆë¡œ ë“¤ì–´ì˜¨ í–‰ ì•ˆì˜ ë§í¬ë“¤ì— ìš°íšŒ ì†ì„± ë¶€ì°©
                    //    ì„œë²„ í…œí”Œë¦¿ì—ì„œ ì´ë¯¸ data-bypass-unload="true" ë„£ì—ˆë‹¤ë©´ ì´ ë¸”ë¡ì€ ìƒëµ ê°€ëŠ¥
                    if (firstRow) {
                        firstRow.querySelectorAll('a[href]')
                            .forEach(a => a.setAttribute('data-bypass-unload', 'true'));
                    }

                    // 4) ì²¨ë¶€íŒŒì¼ Y í‘œì‹œ ë³´ì • (ì´ë²ˆ ì œì¶œì— ì‹¤ì œ íŒŒì¼ì´ ìˆì—ˆìœ¼ë©´ Y)
                    try {
                        const hasFiles = (document.getElementById('files-create')?.files?.length || 0) > 0;
                        if (hasFiles && firstRow) {
                            const cell = firstRow ? firstRow.querySelector('.col-hasfile') : null;
                            if (cell) cell.textContent = 'Y';
                        }
                    } catch (_) {}

                    // 5) í¼/ì—ë””í„°/íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ë„¤ ê¸°ì¡´ ì½”ë“œ)
                    $('#title').val('');
                    try { oEditors?.getById?.["body"]?.exec("SET_IR", ['']); } catch (e) { $('#body').val(''); }
                    $('#files-create').val('');
                    window.__resetFiles?.();

                    // 6) ë”í‹° ê°€ë“œ ë¦¬ì…‹
                    window.__dirtyGuard?.reset?.();

                    // 7) (ì˜µì…˜) beforeunload í‚¬ëŸ¬ ì¬ì ìš© â€” ì—ë””í„°ê°€ ë‚´ë¶€ì—ì„œ ë‹¤ì‹œ ê±¸ì–´ë‘˜ ìˆ˜ ìˆì–´ì„œ í•œ ë²ˆ ë”
                    try {
                        killBeforeUnload(window);
                        const ifr = document.querySelector('#editor-slot iframe');
                        if (ifr?.contentWindow) killBeforeUnload(ifr.contentWindow);
                    } catch (_) {}

                    // 8) (ì„ì‹œ ë””ë²„ê¹…) í•„ìš”í•  ë•Œë§Œ ì¼œê³ , í™•ì¸ ëë‚˜ë©´ ì§€ì›Œë¼
                    // window.addEventListener('beforeunload', e => console.log('FIRE', window.__dirtyGuard), true);
// ì„±ê³µ ì½œë°± ë§¨ ëì¯¤
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // ë¶€ë“œëŸ½ê²Œ ë§¨ ìœ„ë¡œ

                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                error: function (xhr) {
                    alert('ë“±ë¡ ì‹¤íŒ¨: ' + (xhr.responseText || ''));
                }
            });

        });
    })();
</script>


<script>
    // ìƒ/í•˜ìœ„(window, iframe) ì–´ë””ë“  beforeunloadë¥¼ ì™„ì „ ì°¨ë‹¨
    function killBeforeUnload(win){
        try{
            // 1) addEventListener í›„í‚¹: beforeunload ë“±ë¡ ìì²´ë¥¼ ë¬´ì‹œ
            const _add = win.addEventListener.bind(win);
            win.addEventListener = function(type, listener, options){
                if (type === 'beforeunload') return; // ë“±ë¡ ì°¨ë‹¨
                return _add(type, listener, options);
            };

            // 2) onbeforeunload ì§ì ‘ í• ë‹¹ë„ ë´‰ì¸
            try {
                Object.defineProperty(win, 'onbeforeunload', {
                    configurable: true,
                    get(){ return null; },
                    set(_){ /* block */ }
                });
            } catch(_) {
                try { win.onbeforeunload = null; } catch(__) {}
            }

            // 3) ì´ë¯¸ ë¶™ì–´ ìˆì„ ìˆ˜ë„ ìˆëŠ” í•¸ë“¤ëŸ¬ì˜ ì „íŒŒë§Œ ëŠê¸°(ìº¡ì²˜ ë‹¨ê³„)
            _add('beforeunload', function(e){
                e.stopImmediatePropagation();
                // ì ˆëŒ€ e.preventDefault()/returnValue ì„¤ì • ê¸ˆì§€
            }, true);

            // 4) jQueryë¡œ ê±¸ì–´ë‘” ê²ƒë„ í•´ì œ ì‹œë„
            if (win.jQuery) {
                try { win.jQuery(win).off('beforeunload'); win.jQuery(win.document).off('beforeunload'); } catch(_){}
            }

            // ë””ë²„ê·¸
            console.debug('[killer] applied:', win.location?.href || '(iframe)');
        }catch(e){
            console.debug('[killer] error', e);
        }
    }

    // ìƒìœ„ ì°½ì— ë¨¼ì € ì ìš©
    killBeforeUnload(window);

    // ìŠ¤ë§ˆíŠ¸ì—ë””í„° iframeì— ì ìš© (ë¡œë”© íƒ€ì´ë°ì„ ê³ ë ¤í•´ í´ë§)
    (function waitAndPatch(){
        let tries = 0;
        const t = setInterval(()=>{
            tries++;
            const ifr = document.querySelector('#editor-slot iframe');
            const w = ifr && (ifr.contentWindow || (ifr.contentDocument && ifr.contentDocument.defaultView));
            if (w){
                killBeforeUnload(w);
                clearInterval(t);
            }
            if (tries > 80) clearInterval(t); // ~10ì´ˆ íƒ€ì„ì•„ì›ƒ
        }, 125);
    })();
</script>

<script> //ì¸ë¼ì¸í¼ì— ê¸€ì´ í•œìë¼ë„ ì í˜€ìˆìœ¼ë©´
    (function(){

        // ì¸ë¼ì¸ í¼ (posts/_create-inline ì•ˆì˜ í¼)
        var $form = $('#postForm');
        if (!$form.length) return;

        // submit ì¤‘ì—ëŠ” ë– ë‚˜ê¸° ê²½ê³  ì•ˆ ëœ¨ê²Œ
        var isSubmitting = false;

        // HTML â†’ ê±°ì˜-í”Œë ˆì¸ í…ìŠ¤íŠ¸
        function toPlain(html){
            if(!html) return '';
            return html
                .replace(/<[^>]*>/g, ' ')    // íƒœê·¸ ì œê±°
                .replace(/&nbsp;/g, ' ')     // nbsp â†’ ê³µë°±
                .replace(/\s+/g, ' ')        // ì—°ì† ê³µë°± ì •ë¦¬
                .trim();
        }

        // ì§€ê¸ˆ ë”ëŸ¬ìš´ê°€?
        function isDirty(){
            var title = $('#title').val() || '';
            // SE2 ë‚´ìš©ì„ textarea(#body)ì— ë°˜ì˜
            try { oEditors?.getById?.["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}
            var bodyHtml = $('#body').val() || '';
            var body = toPlain(bodyHtml);

            var filesCnt = (document.getElementById('files-create')?.files?.length) || 0;

            // ì–´ë–¤ ê²ƒì´ë¼ë„ ë‚´ìš©ì´ ìˆìœ¼ë©´ dirty
            return (title.trim().length > 0) || (body.length > 0) || (filesCnt > 0);
        }

        // ë– ë‚˜ê¸° ê²½ê³ (ë„¤ì´í‹°ë¸Œ) ì„¤ì¹˜: ìš°ë¦¬ê°€ ì œê³µí•œ ë¹„ë°€ í†µë¡œë¡œë§Œ ë“±ë¡
        if (window.__addBeforeUnload) {
            window.__addBeforeUnload(function(e){
                if (isSubmitting) return;     // ì œì¶œì¤‘ì´ë©´ í—ˆìš©
                if (!isDirty()) return;       // ê¹¨ë—í•˜ë©´ í—ˆìš©
                e.preventDefault();           // í¬ë¡¬ ë“±ì—ì„œ í•„ìš”
                e.returnValue = '';           // ë„¤ì´í‹°ë¸Œ ê²½ê³  íŠ¸ë¦¬ê±°
            });
        }

        // ì‹¤ì œ ì œì¶œ(ìš°ë¦¬ ajax ì œì¶œ í¬í•¨) ì§ì „ì— í”Œë˜ê·¸ on
        $form.on('submit', function(){
            isSubmitting = true;
            // í˜¹ì‹œ ajax ì‹¤íŒ¨ ì‹œë¥¼ ëŒ€ë¹„í•´ 3ì´ˆ ë’¤ ìë™ í•´ì œ(ì›í•˜ë©´ ì¡°ì ˆ)
            setTimeout(function(){ isSubmitting = false; }, 3000);
        });

        // â˜… ajax ì„±ê³µ ì‹œ í•„ë“œ ì´ˆê¸°í™”í•˜ë©´ isDirty()ê°€ ìë™ìœ¼ë¡œ falseê°€ ë¨
        //   (ë„¤ ì½”ë“œì— ì´ë¯¸ ì´ˆê¸°í™” ìˆìŒ: title/body/files ë¹„ìš°ê¸° + window.__resetFiles?.())

        // (ì„ íƒ) â€œê¸€ì“°ê¸°â€ ì´ë™ ê°™ì€ ë²„íŠ¼ì— data-skip-leave-warning ë‹¬ì•˜ìœ¼ë©´,
        //       í´ë¦­ ì‹œ ë§ˆì§€ë§‰ìœ¼ë¡œ í•œ ë²ˆ ë” ì œì¶œì•„ë‹˜ì„ í™•ì¸í•˜ê³  ê·¸ëƒ¥ ì´ë™:
        document.addEventListener('click', function(e){
            var a = e.target.closest('a[data-skip-leave-warning]');
            if(!a) return;
            // êµ³ì´ ë¬´íš¨í™”í•  ê±´ ì—†ìŒ. ìš°ë¦¬ì˜ beforeunloadëŠ” dirtyì¼ ë•Œë§Œ ëœ¨ë‹ˆê¹Œ.
        }, true);

    })();
</script>
<script>
    // 0-1) í˜¹ì‹œ ì „ í˜ì´ì§€ì—ì„œ ë“±ë¡ëœ beforeunload í•¸ë“¤ëŸ¬ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ì œê±°
    if (window.__dirtyGuard && window.__dirtyGuard._handler) {
        window.removeEventListener('beforeunload', window.__dirtyGuard._handler);
    }
    window.onbeforeunload = null;

    // 0-2) í˜¹ì‹œ ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ë“±ë¡ëœ ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ê°€ ìˆì–´ë„ ëª» ì˜¬ë¼ì˜¤ê²Œ ì°¨ë‹¨(ë¦¬ìŠ¤íŠ¸ í•œì • ë°©ì–´)
    window.addEventListener('beforeunload', function(e){
        e.stopImmediatePropagation();
    }, true);

    // 0-3) í˜¹ì‹œ ì „ì—­ í”Œë˜ê·¸ ë‚¨ì•„ìˆë‹¤ë©´ êº¼ë²„ë¦¼
    window.__dirtyGuard = { enabled:false, isDirty:false };
</script>

<script defer th:src="@{/js/confirm.js}"></script>

</body>
</html>
