<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="/js/beforeunload-killer.js"></script>
    <meta charset="utf-8">
    <title>게시글 목록</title>


    <!-- ▼ 파비콘 (기존 이미지로 대체) -->
    <link rel="icon" type="image/png" href="/dist/img/AdminLTELogo.png">


    <link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">

    <!-- ✅ AJAX에서 쓸 CSRF 메타 -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <!-- SmartEditor2 -->
    <script th:src="@{/se2/js/service/HuskyEZCreator.js}" charset="utf-8"></script>
    <link rel="preload" href="/se2/SmartEditor2Skin.html" as="fetch">

    <!-- 에디터 바깥 iframe 100% -->
    <style>
        #editor-slot iframe { width:100% !important; min-width:100% !important; display:block; }
        #editor-slot { width:100%; }
    </style>

    <!-- create 카드 폭을 list와 독립적으로 제어 -->
    <style>
        .create-inline-wrap {
            max-width: 980px;      /* create 페이지 느낌의 폭 */
            margin: 48px auto 0;   /* 위 여백 + 가운데 정렬 */
        }
    </style>




    <!-- ✅ 리스트 페이지에서 beforeunload 경고 완전 차단 (정상 버전: preventDefault 절대 금지) -->
    <script>
        (function () {
            // 앞으로 등록될 beforeunload 리스너 자체를 차단
            const _add = window.addEventListener;
            window.addEventListener = function (type, listener, options) {
                if (type === 'beforeunload') return; // 등록 무시
                return _add.call(this, type, listener, options);
            };

            // window.onbeforeunload = ... 같은 직접 할당도 원천봉쇄
            try {
                Object.defineProperty(window, 'onbeforeunload', {
                    configurable: true,
                    get() { return null; },
                    set(_) { /* block */ }
                });
            } catch (_) {}

            // 혹시 이미 붙어있는 리스너보다 먼저 실행해서 “전파만” 끊는다.
            // ⚠️ 여기서 절대 e.preventDefault()나 e.returnValue 설정하지 말 것!
            _add.call(window, 'beforeunload', function (e) {
                e.stopImmediatePropagation(); // 다른 리스너 실행 못 하게
                // do NOT call e.preventDefault()
                // do NOT set e.returnValue
            }, true);

            // jQuery가 미리 붙였던게 있으면 제거 시도
            if (window.jQuery) {
                try { jQuery(window).off('beforeunload'); jQuery(document).off('beforeunload'); } catch (_) {}
            }
        })();
    </script>

    <style>
        /* 카드 헤더에서 검색 폼을 오른쪽 끝으로 */
        .card-header .search-form { margin-left: auto !important; }

        /* 혹시 가운데 정렬이 남아있을 때 강제 해제 */
        .card-header { text-align: left; }
    </style>


</head>

<body class="hold-transition">
<div class="container-fluid my-4"><!-- .container-fluid: 페이지 전체 폭 -->
    <div class="row">
        <div class="col-12 col-lg-11 col-xl-10 mx-auto"><!-- 중앙 고정폭 컨테이너 -->

            <!-- 상단 로그아웃 버튼 -->


            <div class="d-flex justify-content-end align-items-center mb-4">
                <form th:action="@{/logout}" method="post" class="mb-0">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger btn-sm">로그아웃</button>
                </form>
            </div>


            <!-- 알림 -->
            <div th:replace="~{fragments/alerts :: alerts}"></div>

            <!-- 목록 카드 -->
            <div class="card">
                <div class="card-header d-flex align-items-center">
                    <h3 class="card-title mb-0">게시글 목록</h3>

                    <!-- 🔥 검색창: 오른쪽 끝으로 밀기 위해 search-form에 margin-left:auto -->
                    <form th:action="@{/posts/list}" method="get" class="search-form mb-0">
                        <div class="input-group input-group-sm" style="width: 260px;">
                            <input type="text" name="q" class="form-control" placeholder="Search" th:value="${q}">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>


                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap">
                        <thead>
                        <tr>
                            <th style="width:80px;">글번호</th>
                            <th>제목</th>
                            <th>내용</th>
                            <th style="width:180px;">회원아이디</th>
                            <th style="width:170px;">작성일</th>
                            <th style="width:170px;">수정일</th>
                        </tr>
                        </thead>
                        <tbody id="post-list-body">
                        <tr th:each="p : ${posts.content}">
                            <td th:text="${p.id}"></td>
                            <td><a th:href="@{/posts/{id}(id=${p.id})}" th:text="${p.title}">제목</a></td>
                            <td th:text="${p.bodyPreview}">미리보기</td>
                            <td th:text="${p.authorUserId}"></td>
                            <td th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="${#temporals.format(p.updateAt, 'yyyy-MM-dd HH:mm')}"></td>
                        </tr>
                        <tr id="no-posts-row" th:if="${#lists.isEmpty(posts.content)}">
                            <td colspan="6" class="text-center text-muted p-4">게시글이 없습니다.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-right">
                        <li class="page-item" th:classappend="${posts.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/posts/list(page=${posts.number-1}, size=${posts.size}, q=${q})}">&laquo;</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, posts.totalPages-1)}"
                            th:classappend="${i} == ${posts.number} ? 'active'">
                            <a class="page-link"
                               th:text="${i+1}"
                               th:href="@{/posts/list(page=${i}, size=${posts.size}, q=${q})}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${posts.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/posts/list(page=${posts.number+1}, size=${posts.size}, q=${q})}">&raquo;</a>
                        </li>
                    </ul>
                </div>
            </div><!-- /.card -->

            <!-- 글쓰기 버튼 (이 버튼은 경고 없이 이동) -->
            <a th:href="@{/posts/create}"
               class="btn btn-primary float-right mb-3"
               data-skip-leave-warning>글쓰기</a>

            <div class="clearfix"></div>

            <!-- 인라인 create: list 폭과 독립 -->
            <div class="create-inline-wrap container mt-4">

<!--                div로 공간을 만들어서 create-inline(list에 추가할 create폼)을 넣어 치환, 스프링+타임리프가 서버에서 템플릿을 html로 렌더해서 브라우저로 보내는 서버사이드. th:replace는 서버사이드 조립-->
                <div th:replace="~{posts/_create-inline :: inlineCreate}"></div>
            </div>

        </div><!-- /.col -->
    </div><!-- /.row -->
</div><!-- /.container-fluid -->

<!-- 필수 JS -->
<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/dist/js/adminlte.min.js}"></script>

<!-- 에디터 폭 보강: iframe 뜰 때까지 짧게 폴링 -->
<script th:inline="javascript">
    var __se2Watch = setInterval(function(){
        var iframe = document.querySelector('#editor-slot iframe');
        if(!iframe) return;
        var doc = iframe.contentDocument || iframe.contentWindow?.document;
        if(!doc) return;
        try { if (window.makeSE2Responsive) window.makeSE2Responsive(); } catch(e){}
        clearInterval(__se2Watch);
    }, 120);
    setTimeout(function(){ clearInterval(__se2Watch); }, 8000);
</script>

<!-- SmartEditor2 스킨 로드 + 반응형 보정 -->
<script th:inline="javascript">
    var oEditors = [];
    var skinUri = /*[[@{/se2/SmartEditor2Skin.html}]]*/ '/se2/SmartEditor2Skin.html';
    skinUri += (skinUri.indexOf('?') === -1 ? '?' : '&') + 'v=' + Date.now();

    function makeSE2Responsive(){
        var iframe = document.querySelector('#editor-slot iframe') ||
            document.querySelector('iframe[src*="SmartEditor2Skin"]');
        if (!iframe) return false;

        iframe.style.width = '100%';
        iframe.removeAttribute('width');

        var doc = iframe.contentDocument || iframe.contentWindow?.document;
        if (!doc) return false;

        if (!doc.getElementById('se2-rwd-css')) {
            var style = doc.createElement('style');
            style.id = 'se2-rwd-css';
            style.textContent = `
          html, body { width:100% !important; overflow-x:hidden !important; }
          .se2_mwrapper, .se2_inwrap, .se2_workarea, .se2_workspace,
          .se2_editor, .se2_input_area, .se2_ui_layout,
          .se2_container, .se2_canvas, .se2_wysiwyg_area,
          iframe, table, td { max-width:100% !important; width:100% !important; }
        `;
            doc.head.appendChild(style);
        }

        function normalize(root){
            root.querySelectorAll('[width], [style*="width"]').forEach(function(el){
                var wAttr = el.getAttribute && el.getAttribute('width');
                if (wAttr && /^\d+$/.test(wAttr)) el.setAttribute('width', '100%');
                var sw = el.style && el.style.width;
                if (sw && /px/.test(sw)) el.style.width = '100%';
            });
        }
        normalize(doc);

        if (!doc.__se2Observer) {
            doc.__se2Observer = new MutationObserver(function(muts){
                muts.forEach(function(m){
                    if (m.type === 'attributes') normalize(m.target);
                    m.addedNodes && m.addedNodes.forEach(function(n){
                        if (n.nodeType === 1) normalize(n);
                    });
                });
            });
            doc.__se2Observer.observe(doc.documentElement, {
                subtree: true, childList: true, attributes: true,
                attributeFilter: ['style','width']
            });
        }
        return true;
    }

    // SmartEditor2 생성
    nhn.husky.EZCreator.createInIFrame({
        oAppRef: oEditors,
        elPlaceHolder: "body",
        sSkinURI: skinUri,
        fCreator: "createSEditor2",
        htParams: { bUseToolbar:true, bUseVerticalResizer:false, bUseModeChanger:true },
        fOnAppLoad: function () {
            try { oEditors.getById["body"].exec("RESIZE_EDITING_AREA", [420]); } catch(e){}
            // 폭 보정 가동
            (function arm(){
                var ok = makeSE2Responsive();
                if (ok) return;
                var tries = 0, t = setInterval(function(){
                    if (makeSE2Responsive() || ++tries > 60) clearInterval(t);
                }, 100);
            })();
            setTimeout(makeSE2Responsive, 400);
        }
    });

    // 리사이즈 시에도 보정
    window.addEventListener('resize', function(){ requestAnimationFrame(makeSE2Responsive); });
</script>

<!-- 파일 드롭/피커 스크립트 & AJAX 제출 (네 기존 코드 유지) -->
<script th:inline="javascript">
    (function(){
        var MAX_FILE_SIZE_MB = 20, MAX_REQ_SIZE_MB = 25;
        var MAX_FILE_SIZE = MAX_FILE_SIZE_MB*1024*1024, MAX_REQ_SIZE = MAX_REQ_SIZE_MB*1024*1024;

        function fmt(b){var u=['B','KB','MB','GB'],i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (n<10&&i>0?n.toFixed(1):Math.round(n))+' '+u[i];}
        function keyOf(f){ return [f.name,f.size,f.lastModified].join('#'); }
        function showSizeModal(html){ $('#sizeLimitBody').html(html); $('#sizeLimitModal').modal('show'); }

        function wirePicker(opts){
            var $form=$(opts.formSelector||'#postForm');
            var $btn=$(opts.btnId), $dz=$(opts.dropzoneId),
                $picker=$(opts.pickerId), $input=$(opts.submitInputId), $list=$(opts.listId);
            if(!$btn.length||!$picker.length||!$input.length||!$list.length) return;

            var selected=new Map();

            function validate(files){
                var total=0, over=[];
                var all=[...selected.values(), ...Array.from(files)];
                for(var i=0;i<all.length;i++){ total+=all[i].size; if(all[i].size>MAX_FILE_SIZE) over.push(all[i]); }
                if(over.length || total>MAX_REQ_SIZE){
                    var html='';
                    if(over.length){
                        html += '<div class="mb-2">개별 파일은 최대 <b>'+MAX_FILE_SIZE_MB+'MB</b>까지 허용합니다.</div><ul>';
                        over.forEach(f=>html+='<li>'+f.name+' — '+fmt(f.size)+'</li>'); html+='</ul>';
                    }
                    if(total>MAX_REQ_SIZE){
                        html+='<div class="mt-2">선택한 파일 합계가 <b>'+MAX_REQ_SIZE_MB+'MB</b>를 초과했습니다.</div>';
                    }
                    showSizeModal(html); return false;
                }
                return true;
            }
            function syncHidden(){
                var dt=new DataTransfer(); selected.forEach(f=>dt.items.add(f));
                $input[0].files = dt.files;
            }
            function render(){
                $list.empty();
                if(selected.size===0){ $list.append('<li class="list-group-item text-muted">선택된 파일이 없습니다.</li>'); return; }
                selected.forEach(function(f,k){
                    var $li=$('<li class="list-group-item d-flex justify-content-between align-items-center"></li>');
                    $li.append('<span>'+f.name+' <small class="text-muted">— '+fmt(f.size)+'</small></span>');
                    var $del=$('<button type="button" class="btn btn-sm btn-outline-danger">삭제</button>');
                    $del.on('click', function(){ selected.delete(k); syncHidden(); render(); });
                    $li.append($del); $list.append($li);
                });
            }
            function addFiles(fileList){
                var arr=Array.from(fileList||[]), unique=arr.filter(f=>!selected.has(keyOf(f)));
                if(unique.length===0) return;
                if(!validate(unique)) return;
                unique.forEach(f=>selected.set(keyOf(f),f));
                syncHidden(); render();
            }
            $btn.on('click', ()=> $picker.trigger('click'));
            $picker.on('change', function(){ addFiles(this.files); this.value=''; });
            $dz.on('dragover', function(e){ e.preventDefault(); e.originalEvent.dataTransfer.dropEffect='copy'; $dz.addClass('bg-light'); });
            $dz.on('dragleave', function(){ $dz.removeClass('bg-light'); });
            $dz.on('drop', function(e){ e.preventDefault(); $dz.removeClass('bg-light'); addFiles(e.originalEvent.dataTransfer.files); });

            window.__resetFiles = function(){ selected.clear(); syncHidden(); render(); };
            render();
        }

        $(function(){
            wirePicker({
                btnId:'#addBtn-create',
                dropzoneId:'#dz-create',
                pickerId:'#picker-create',
                submitInputId:'#files-create',
                listId:'#list-create',
                formSelector:'#postForm'
            });
        });
    })();





    (function(){ //submit가로채서 등록절차 진행 createRow로 보냄 Controller
        var $form = $('#postForm'); //postForm은 _crate-inline 폼
        if(!$form.length) return;

        function prependRowHtml(html){
            if(!html) return;
            $('#post-list-body').prepend(html); //post-list-body 글 들어가는 목록에 prepend(추가)html을.여기서 html은 _post-row.html의 tr~tr. 곧 글 한줄을 말함.최근글이 맨 위로 뜨게.
            $('#no-posts-row').remove();
        }

        $form.on('submit', function(e){ //create-inline폼의 submit이 클릭되면 가로챈다
            e.preventDefault(); //원래의 "페이지 이동" 막음
            //스마트 에디터의 내용을 textarea(#body)로 복사

            try { oEditors?.getById?.["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}
            var title = $('#title').val()?.trim();
            var body  = $('#body').val()?.trim();
            if(!title){ alert('제목을 입력하세요.'); $('#title').focus(); return; }
            if(!body){  alert('본문을 입력하세요.'); return; }

            var fd = new FormData(this); //this 현재 submit된 폼 데이터, name으로 필드를 모으는데 name="title" input title=123 name ="body" textarea body=안녕" 뭐 이런식?
            $.ajax({
                url: $form.attr('action'), //posts/row로 ajax POST
                method: 'POST',
                data: fd,
                processData: false, //jquery의 ajax는 js객체를 쿼리스트링으로 변환하려고 하기때문에 formdata는 그대로 보내야하므로 false
                contentType: false,
                success: function(html){ // 여기서 html은 서버가 보낸 tr~tr(_post-row)글 한줄이 담겨있음
                    prependRowHtml(html);
                    $('#title').val('');
                    try { oEditors?.getById?.["body"]?.exec("SET_IR", ['']); } catch(e){ $('#body').val(''); }
                    $('#files-create').val('');
                    window.__resetFiles?.();
                    alert('등록되었습니다.');
                },
                error: function(xhr){
                    alert('등록 실패: ' + (xhr.responseText || ''));
                }
            });
        });
    })();
</script>

<script defer th:src="@{/js/confirm.js}"></script>

</body>
</html>
