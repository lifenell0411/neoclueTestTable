<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/plugins/fontawesome-free/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/dist/css/adminlte.min.css}">
    <!-- âœ… AJAXì—ì„œ ì“¸ CSRF ë©”íƒ€ -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <script th:src="@{/se2/js/service/HuskyEZCreator.js}" charset="utf-8"></script>
    <link rel="preload" as="document" href="/se2/SmartEditor2Skin.html">


    <style>
        /* ë°”ê¹¥ iframe ìì²´ë¥¼ ë¨¼ì € 100%ë¡œ */
        #editor-slot iframe {
            width: 100% !important;
            min-width: 100% !important;
            display: block;
        }
        /* ìŠ¬ë¡¯ ìì²´ë„ 100% ë³´ì¥ */
        #editor-slot { width: 100%; }
    </style>


    <style>
        /* createëŠ” ë¦¬ìŠ¤íŠ¸ì™€ ë…ë¦½ëœ í­(ì›ë˜ create í˜ì´ì§€ ëŠë‚Œ) */
        .create-inline-wrap{
            max-width: 980px;      /* ì›ë˜ create í˜ì´ì§€ ì¹´ë“œ í­ ëŠë‚Œ */
            margin: 48px auto 0;   /* ìœ„ë¡œ ê°„ê²© + ê°€ìš´ë° ì •ë ¬ */
        }
    </style>


</head>


<body class="hold-transition">
<!--<div class="d-flex justify-content-center align-items-center vh-100">-->
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-12 col-lg-11 col-xl-10 mx-auto">
    <!-- ìƒë‹¨ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <form th:action="@{/logout}" method="post" style="position:absolute; top:20px; right:20px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
    </form>




        <div th:replace="fragments/alerts :: alerts"></div>





        <div class="card">
            <div class="card-header">
                                <h3 class="card-title">ê²Œì‹œê¸€ ëª©ë¡</h3>
                <div class="card-tools">
                                    <form th:action="@{/posts/list}" method="get">
                                        <div class="input-group input-group-sm" style="width: 220px;">
                                            <input type="text" name="q" class="form-control float-right" placeholder="Search"
                                                   th:value="${q}">
                                            <div class="input-group-append">
                                                <button type="submit" class="btn btn-default">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>




                            <!-- /.card-header -->

                            <div class="card-body table-responsive p-0">
                                <table class="table table-hover text-nowrap">
                                    <thead>
                                    <tr>
                                        <th style="width:80px;">ê¸€ë²ˆí˜¸</th>
                                        <th>ì œëª©</th>
                                        <th>ë‚´ìš©</th>
                                        <th style="width:180px;">íšŒì›ì•„ì´ë””</th>
                                        <th style="width:170px;">ì‘ì„±ì¼</th>
                                        <th style="width:170px;">ìˆ˜ì •ì¼</th>
                                    </tr>
                                    </thead>
                                    <tbody id="post-list-body">
                                    <tr th:each="p : ${posts.content}">
                                        <td th:text="${p.id}"></td>
                                        <td>
                                            <a th:href="@{/posts/{id}(id=${p.id})}" th:text="${p.title}">ì œëª©</a>
                                        </td>
                                        <td th:text="${p.bodyPreview}">ë¯¸ë¦¬ë³´ê¸°</td> <!-- ğŸ‘ˆ ì´ê±° í•˜ë‚˜ë©´ ë -->
                                        <td th:text="${p.authorUserId}"></td>
                                        <td th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                                        <td th:text="${#temporals.format(p.updateAt, 'yyyy-MM-dd HH:mm')}"></td>
                                    </tr>
                                    <tr id="no-posts-row" th:if="${#lists.isEmpty(posts.content)}">
                                        <td colspan="6" class="text-center text-muted p-4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.card-body -->

                            <div class="card-footer clearfix">


                                <ul class="pagination pagination-sm m-0 float-right">
                                    <li class="page-item" th:classappend="${posts.first} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/posts/list(page=${posts.number-1}, size=${posts.size}, q=${q})}">&laquo;</a>
                                    </li>

                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, posts.totalPages-1)}"
                                        th:classappend="${i} == ${posts.number} ? 'active'">
                                        <a class="page-link"
                                           th:text="${i+1}"
                                           th:href="@{/posts/list(page=${i}, size=${posts.size}, q=${q})}">1</a>
                                    </li>

                                    <li class="page-item" th:classappend="${posts.last} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/posts/list(page=${posts.number+1}, size=${posts.size}, q=${q})}">&raquo;</a>
                                    </li>
                                </ul>
                            </div>
                            <!-- /.card-footer -->

                        </div>
            <!-- ê¸€ì“°ê¸° ë²„íŠ¼ì— ì—¬ë°± ì¶”ê°€ -->
            <a th:href="@{/posts/create}"
               class="btn btn-primary float-right mb-3"
               data-skip-leave-warning>ê¸€ì“°ê¸°</a>

            <!-- í”Œë¡œíŠ¸ í•´ì œ (ë‹¤ìŒ ìš”ì†Œê°€ ì–¹íˆëŠ” ê±¸ ë°©ì§€) -->
            <div class="clearfix"></div>

            <!-- âœ… create ì „ìš© ë˜í¼: ë¦¬ìŠ¤íŠ¸ì™€ í­ ë¶„ë¦¬ -->
            <div class="create-inline-wrap container mt-4">
                <div th:replace="posts/_create-inline :: inlineCreate"></div>
            </div>


                    </div>
                </div>




<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/dist/js/adminlte.min.js}"></script>






    <script th:inline="javascript">
        // ì—ë””í„° iframeì´ ì‹¤ì œë¡œ ëœ° ë•Œê¹Œì§€ ì§§ê²Œ í´ë§í•´ì„œ í­ ë³´ê°•
        var __se2Watch = setInterval(function(){
            var iframe = document.querySelector('#editor-slot iframe');
            if(!iframe) return;
            var doc = iframe.contentDocument || iframe.contentWindow?.document;
            if(!doc) return;
            // í•œ ë²ˆì´ë¼ë„ ì°¾ìœ¼ë©´ ë³´ê°•í•˜ê³  ì¢…ë£Œ
            try { fixSE2InnerWidth(); } catch(e){}
            clearInterval(__se2Watch);
        }, 120);
        // 8ì´ˆ ë„˜ìœ¼ë©´ ì•ˆì „ ì¢…ë£Œ
        setTimeout(function(){ clearInterval(__se2Watch); }, 8000);
    </script>






    <script th:inline="javascript">
        var oEditors = [];
        var skinUri = /*[[@{/se2/SmartEditor2Skin.html}]]*/ '/se2/SmartEditor2Skin.html';
        // ìºì‹œ ë²„ìŠ¤í„°
        skinUri += (skinUri.indexOf('?') === -1 ? '?' : '&') + 'v=' + Date.now();

        // --- í•µì‹¬: ìŠ¤í‚¨ ë‚´ë¶€ px í­ì„ ê³„ì† 100%ë¡œ ê°•ì œí•˜ëŠ” í•¨ìˆ˜ + ì˜µì €ë²„ ---
        function makeSE2Responsive(){
            var iframe = document.querySelector('#editor-slot iframe') ||
                document.querySelector('iframe[src*="SmartEditor2Skin"]');
            if (!iframe) return false;

            // ë°”ê¹¥ iframe ìì²´ë¥¼ 100%
            iframe.style.width = '100%';
            iframe.removeAttribute('width');

            var doc = iframe.contentDocument || iframe.contentWindow?.document;
            if (!doc) return false;

            // í•œë²ˆë§Œ ì£¼ì…ë˜ëŠ” ìŠ¤íƒ€ì¼ (iframe ë‚´ë¶€ ì „ìš©)
            if (!doc.getElementById('se2-rwd-css')) {
                var style = doc.createElement('style');
                style.id = 'se2-rwd-css';
                style.textContent = `
        html, body { width:100% !important; overflow-x:hidden !important; }

        /* ìŠ¤í‚¨ ì£¼ìš” ë˜í¼ ì „ë¶€ 100% */
        .se2_mwrapper, .se2_inwrap, .se2_workarea, .se2_workspace,
        .se2_editor, .se2_input_area, .se2_ui_layout,
        .se2_container, .se2_canvas, .se2_wysiwyg_area,
        iframe, table, td {
          max-width:100% !important; width:100% !important;
        }
      `;
                doc.head.appendChild(style);
            }

            // px/ìˆ«ì width ì†ì„±ë“¤ì„ 100%ë¡œ ì •ê·œí™”
            function normalize(root){
                root.querySelectorAll('[width], [style*="width"]').forEach(function(el){
                    // width="650" ê°™ì€ ì†ì„±
                    var wAttr = el.getAttribute && el.getAttribute('width');
                    if (wAttr && /^\d+$/.test(wAttr)) el.setAttribute('width', '100%');

                    // style="width: 650px" ê°™ì€ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼
                    var sw = el.style && el.style.width;
                    if (sw && /px/.test(sw)) el.style.width = '100%';
                });
            }
            normalize(doc);

            // ìŠ¤í‚¨ì´ DOMì„ ë‹¤ì‹œ ë§Œë“¤ ë•Œë„ ì¦‰ì‹œ ì¬-ì •ê·œí™” (ëª¨ë“œ ì „í™˜ ë“±)
            if (!doc.__se2Observer) {
                doc.__se2Observer = new MutationObserver(function(muts){
                    muts.forEach(function(m){
                        if (m.type === 'attributes') normalize(m.target);
                        m.addedNodes && m.addedNodes.forEach(function(n){
                            if (n.nodeType === 1) normalize(n);
                        });
                    });
                });
                doc.__se2Observer.observe(doc.documentElement, {
                    subtree: true, childList: true, attributes: true,
                    attributeFilter: ['style','width']
                });
            }

            return true;
        }

        // ì—ë””í„° ë¡œë”© íƒ€ì´ë° ì´ìŠˆ ëŒ€ë¹„: í´ë§ìœ¼ë¡œ í•œë²ˆ ì¡ê³ , ì´í›„ì—” ì˜µì €ë²„ê°€ ìœ ì§€ë³´ìˆ˜
        function armSE2Fix(){
            var okNow = makeSE2Responsive();
            if (okNow) return;

            var tries = 0, timer = setInterval(function(){
                if (makeSE2Responsive() || ++tries > 60) clearInterval(timer); // ìµœëŒ€ 6ì´ˆ ì‹œë„
            }, 100);
        }

        // SmartEditor2 ìƒì„±
        nhn.husky.EZCreator.createInIFrame({
            oAppRef: oEditors,
            elPlaceHolder: "body",
            sSkinURI: skinUri,
            fCreator: "createSEditor2",
            htParams: { bUseToolbar:true, bUseVerticalResizer:false, bUseModeChanger:true },
            fOnAppLoad: function () {
                try { oEditors.getById["body"].exec("RESIZE_EDITING_AREA", [420]); } catch(e){}
                // í­ ë³´ì • ê°€ë™
                armSE2Fix();
                // ì•½ê°„ì˜ ì§€ì—° í›„ í•œ ë²ˆ ë” ë³´ì • (ì´ˆê¸° ë ˆì´ì•„ì›ƒ ì´í›„)
                setTimeout(armSE2Fix, 400);
            }
        });

        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ë„ ë³´ì •
        window.addEventListener('resize', function(){ requestAnimationFrame(makeSE2Responsive); });


    // ===== 3-2) ë„¤ê°€ ì“°ë˜ íŒŒì¼ ë“œë¡­ì¡´/í”¼ì»¤ ìŠ¤í¬ë¦½íŠ¸ ë°”ì¸ë”© =====
    (function(){
        var MAX_FILE_SIZE_MB = 20, MAX_REQ_SIZE_MB = 25;
        var MAX_FILE_SIZE = MAX_FILE_SIZE_MB*1024*1024, MAX_REQ_SIZE = MAX_REQ_SIZE_MB*1024*1024;

        function fmt(b){var u=['B','KB','MB','GB'],i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (n<10&&i>0?n.toFixed(1):Math.round(n))+' '+u[i];}
        function keyOf(f){ return [f.name,f.size,f.lastModified].join('#'); }
        function showSizeModal(html){ $('#sizeLimitBody').html(html); $('#sizeLimitModal').modal('show'); }

        function wirePicker(opts){
            var $form=$(opts.formSelector||'#postForm');
            var $btn=$(opts.btnId), $dz=$(opts.dropzoneId),
                $picker=$(opts.pickerId), $input=$(opts.submitInputId), $list=$(opts.listId);
            if(!$btn.length||!$picker.length||!$input.length||!$list.length) return;

            var selected=new Map();

            function validate(files){
                var total=0, over=[];
                var all=[...selected.values(), ...Array.from(files)];
                for(var i=0;i<all.length;i++){ total+=all[i].size; if(all[i].size>MAX_FILE_SIZE) over.push(all[i]); }
                if(over.length || total>MAX_REQ_SIZE){
                    var html='';
                    if(over.length){
                        html += '<div class="mb-2">ê°œë³„ íŒŒì¼ì€ ìµœëŒ€ <b>'+MAX_FILE_SIZE_MB+'MB</b>ê¹Œì§€ í—ˆìš©í•©ë‹ˆë‹¤.</div><ul>';
                        over.forEach(f=>html+='<li>'+f.name+' â€” '+fmt(f.size)+'</li>'); html+='</ul>';
                    }
                    if(total>MAX_REQ_SIZE){
                        html+='<div class="mt-2">ì„ íƒí•œ íŒŒì¼ í•©ê³„ê°€ <b>'+MAX_REQ_SIZE_MB+'MB</b>ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.</div>';
                    }
                    showSizeModal(html); return false;
                }
                return true;
            }
            function syncHidden(){
                var dt=new DataTransfer(); selected.forEach(f=>dt.items.add(f));
                $input[0].files = dt.files;
            }
            function render(){
                $list.empty();
                if(selected.size===0){ $list.append('<li class="list-group-item text-muted">ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>'); return; }
                selected.forEach(function(f,k){
                    var $li=$('<li class="list-group-item d-flex justify-content-between align-items-center"></li>');
                    $li.append('<span>'+f.name+' <small class="text-muted">â€” '+fmt(f.size)+'</small></span>');
                    var $del=$('<button type="button" class="btn btn-sm btn-outline-danger">ì‚­ì œ</button>');
                    $del.on('click', function(){ selected.delete(k); syncHidden(); render(); });
                    $li.append($del); $list.append($li);
                });
            }
            function addFiles(fileList){
                var arr=Array.from(fileList||[]), unique=arr.filter(f=>!selected.has(keyOf(f)));
                if(unique.length===0) return;
                if(!validate(unique)) return;
                unique.forEach(f=>selected.set(keyOf(f),f));
                syncHidden(); render();
            }
            $btn.on('click', ()=> $picker.trigger('click'));
            $picker.on('change', function(){ addFiles(this.files); this.value=''; });
            $dz.on('dragover', function(e){ e.preventDefault(); e.originalEvent.dataTransfer.dropEffect='copy'; $dz.addClass('bg-light'); });
            $dz.on('dragleave', function(){ $dz.removeClass('bg-light'); });
            $dz.on('drop', function(e){ e.preventDefault(); $dz.removeClass('bg-light'); addFiles(e.originalEvent.dataTransfer.files); });

            // ì™¸ë¶€ ì´ˆê¸°í™”ìš©
            window.__resetFiles = function(){ selected.clear(); syncHidden(); render(); };
            render();
        }

        // create-inlineì— ë§ì¶° 1íšŒ ë°”ì¸ë”©
        $(function(){
            wirePicker({
                btnId:'#addBtn-create',
                dropzoneId:'#dz-create',
                pickerId:'#picker-create',
                submitInputId:'#files-create',
                listId:'#list-create',
                formSelector:'#postForm'
            });
        });
    })();

    // ===== 3-3) AJAX ì œì¶œ(í”„ë˜ê·¸ë¨¼íŠ¸ ë°˜í™˜) =====
    (function(){
        var $form = $('#postForm');           // í”„ë˜ê·¸ë¨¼íŠ¸ì˜ í¼ id ê·¸ëŒ€ë¡œ
        if(!$form.length) return;

        function prependRowHtml(html){
            if(!html) return;
            $('#post-list-body').prepend(html);
            $('#no-posts-row').remove();
        }

        $form.on('submit', function(e){
            e.preventDefault();

            // ì„¸ë””í„° ë‚´ìš©ì„ textareaë¡œ ë°˜ì˜
            try { oEditors?.getById?.["body"]?.exec("UPDATE_CONTENTS_FIELD", []); } catch(e){}

            // ê°„ë‹¨ ìœ íš¨ì„±
            var title = $('#title').val()?.trim();
            var body  = $('#body').val()?.trim();
            if(!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); $('#title').focus(); return; }
            if(!body){  alert('ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

            var fd = new FormData(this); // hidden CSRF + files í¬í•¨ ê·¸ëŒ€ë¡œ ì „ì†¡
            $.ajax({
                url: $form.attr('action'),    // /posts/row
                method: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                success: function(html){
                    prependRowHtml(html);
                    // í¼ ì´ˆê¸°í™”
                    $('#title').val('');
                    try { oEditors?.getById?.["body"]?.exec("SET_IR", ['']); } catch(e){ $('#body').val(''); }
                    $('#files-create').val('');
                    window.__resetFiles?.();
                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                error: function(xhr){
                    alert('ë“±ë¡ ì‹¤íŒ¨: ' + (xhr.responseText || ''));
                }
            });
        });
    })();
</script>











</body>
</html>
